<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Inovera Creation - Secure Admin System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* আপনার অরিজিনাল সিএসএস ডিজাইন পুরোপুরি সংরক্ষিত */
        :root { --primary: #f28c28; --bg: #fffbf5; --red: #d32f2f; --green: #27ae60; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #e0e0e0; padding: 20px; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #222; color: white; display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: #333; padding: 40px; border-radius: 15px; text-align: center; box-shadow: 0 0 30px rgba(0,0,0,0.7); }
        .login-box input { padding: 12px; margin: 15px; border-radius: 5px; border: none; width: 250px; font-size: 16px; text-align: center; }
        .top-search-bar { max-width: 850px; margin: 0 auto 15px; background: #333; color: white; padding: 15px; border-radius: 8px; text-align: center; }
        #main-search { width: 60%; padding: 10px; border-radius: 5px; border: none; }
        .controls { max-width: 850px; margin: 0 auto 20px; background: white; padding: 15px; border-radius: 8px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .invoice-container { max-width: 800px; margin: auto; background: white; padding: 40px; min-height: 1050px; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.2); }
        #seal-container { position: absolute; width: 120px; cursor: move; z-index: 100; top: 800px; left: 600px; }
        button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: bold; }
        .modal { display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); }
        .modal-content { background:#fff; margin:10% auto; padding:20px; width:300px; border-radius:10px; text-align:center; }
        @media print { .no-print, #login-screen { display: none !important; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="color:var(--primary)">INOVERA CREATION</h1>
            <p>সিস্টেমে প্রবেশের জন্য পাসওয়ার্ড দিন</p>
            <input type="password" id="sys-pass" placeholder="পাসওয়ার্ড লিখুন"> <br>
            <button onclick="checkLogin()" style="background: var(--primary); width:100px;">প্রবেশ করুন</button>
        </div>
    </div>

    <div id="main-content" style="display:none;">
        <div class="top-search-bar no-print">
            <input type="text" id="main-search" placeholder="বিল নম্বর বা নাম দিয়ে খুঁজুন..." onkeyup="globalSearch()">
            <div id="search-results"></div>
        </div>

        <div class="controls no-print">
            <button onclick="addRow()" style="background:var(--green);">+ Item</button>
            <button onclick="saveInvoice()" id="save-btn" style="background:#3498db;">Save Online</button>
            <button onclick="downloadAction('pdf')" style="background:#9b59b6;">Download PDF</button>
            <button onclick="downloadAction('jpg')" style="background:#e67e22;">Save JPG</button>
            <button onclick="deleteInvoice()" style="background:var(--red);">Delete Bill</button>
            <button onclick="openSettings()" style="background:#555;">Settings ⚙️</button>
            <button onclick="location.reload()" style="background:#7f8c8d;">Logout</button>
        </div>

        <div class="invoice-container" id="printable-area">
             <div id="invoice-part">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1 style="font-size: 45px; color: var(--primary); margin:0;">INVOICE</h1>
                    <img id="logo-preview" src="https://via.placeholder.com/150x50?text=Your+Logo" style="max-width:150px; cursor:pointer;" onclick="document.getElementById('logo-input').click()">
                </div>
                <div id="seal-container"><img id="seal-img" src="https://via.placeholder.com/120x120?text=Digital+Seal" style="width:120px; opacity:0.8; cursor:pointer;" onclick="document.getElementById('seal-input').click()"></div>
                
                <table style="margin-top:20px; width:100%;">
                    <tr><td width="15%">Inv No:</td><td width="35%"><input type="text" id="inv-no" value="IC-2026-001"></td><td width="15%">Date:</td><td><input type="text" id="inv-date"></td></tr>
                    <tr><td>Name:</td><td colspan="3"><input type="text" id="c-name" oninput="showSummary(this.value)"></td></tr>
                </table>

                <table id="item-table" style="margin-top:20px; width:100%; border:1px solid var(--primary);">
                    <thead><tr style="background:var(--bg);"><th>SL</th><th width="50%">Description</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead>
                    <tbody id="tbody"></tbody>
                </table>
                <div style="margin-left:auto; width:45%; margin-top:15px;">
                    <table style="width:100%;">
                        <tr><td align="right">Sub Total:</td><td><input type="number" id="sub-total" readonly></td></tr>
                        <tr><td align="right">Advance:</td><td><input type="number" id="advance" value="0" oninput="calculate()"></td></tr>
                        <tr style="background:var(--bg); font-weight:bold;"><td align="right">Due Amount:</td><td><input type="number" id="due" readonly></td></tr>
                    </table>
                </div>
             </div>

             <div id="summary-part" style="display:none; margin-top:50px; border-top:2px dashed #ccc; padding-top:20px;">
                <h3 style="text-align:center; color:var(--primary);">Statement Summary</h3>
                <div id="sum-content"></div>
             </div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h3>পাসওয়ার্ড পরিবর্তন করুন</h3>
            <p>লগইন পাসওয়ার্ড:</p>
            <input type="text" id="new-sys-pass" placeholder="Login Password">
            <p>এডমিন ডিলিট পাসওয়ার্ড:</p>
            <input type="text" id="new-admin-pass" placeholder="Admin Password">
            <br><br>
            <button onclick="saveSettings()" style="background:var(--green);">Save Settings</button>
            <button onclick="closeSettings()" style="background:var(--red);">Close</button>
        </div>
    </div>

    <input type="file" id="logo-input" accept="image/*" style="display:none" onchange="previewImg(this, 'logo-preview')">
    <input type="file" id="seal-input" accept="image/*" style="display:none" onchange="previewImg(this, 'seal-img')">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, set, get, child, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD564XNDplN4_1YACVsGSPejchc3XMIB20",
            authDomain: "special-inventon.firebaseapp.com",
            databaseURL: "https://special-inventon-default-rtdb.firebaseio.com",
            projectId: "special-inventon",
            storageBucket: "special-inventon.firebasestorage.app",
            messagingSenderId: "188677302653",
            appId: "1:188677302653:web:d65812ec5a63f2c2cd4414"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // লগইন চেক এবং অনলাইন পাসওয়ার্ড লোড
        window.checkLogin = async function() {
            const inputPass = document.getElementById('sys-pass').value;
            const snapshot = await get(child(ref(db), 'settings/passwords'));
            let validPass = "1234"; // ডিফল্ট
            if(snapshot.exists()) validPass = snapshot.val().login;

            if(inputPass === validPass) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            } else { alert("ভুল পাসওয়ার্ড!"); }
        };

        // পাসওয়ার্ড সেটিংস সেভ
        window.saveSettings = function() {
            const loginP = document.getElementById('new-sys-pass').value;
            const adminP = document.getElementById('new-admin-pass').value;
            if(!loginP || !adminP) return alert("সব ঘর পূরণ করুন!");
            
            set(ref(db, 'settings/passwords'), { login: loginP, admin: adminP })
                .then(() => { alert("পাসওয়ার্ড সফলভাবে পরিবর্তন হয়েছে!"); closeSettings(); });
        };

        // বিল ডিলিট (Admin Password দিয়ে)
        window.deleteInvoice = async function() {
            const snapshot = await get(child(ref(db), 'settings/passwords'));
            let adminPass = "9988"; // ডিফল্ট
            if(snapshot.exists()) adminPass = snapshot.val().admin;

            const input = prompt("এডমিন পাসওয়ার্ড দিন:");
            if(input === adminPass) {
                const id = document.getElementById('inv-no').value.replace(/\W/g, '_');
                remove(ref(db, 'invoices/' + id)).then(() => { alert("বিল মুছে ফেলা হয়েছে!"); location.reload(); });
            } else { alert("ভুল এডমিন পাসওয়ার্ড!"); }
        };

        // ইনভয়েস সেভ
        window.saveInvoice = function() {
            const btn = document.getElementById('save-btn');
            btn.innerText = "Saving...";
            const id = document.getElementById('inv-no').value.replace(/\W/g, '_');
            const data = {
                invNo: document.getElementById('inv-no').value,
                name: document.getElementById('c-name').value,
                total: document.getElementById('sub-total').value,
                adv: document.getElementById('advance').value,
                date: document.getElementById('inv-date').value,
                items: Array.from(document.querySelectorAll('#tbody tr')).map(r => ({
                    d: r.querySelector('.item-desc').value,
                    t: r.querySelector('.row-total').value
                }))
            };
            set(ref(db, 'invoices/' + id), data).then(() => {
                alert("অনলাইনে সেভ হয়েছে!");
                btn.innerText = "Save Online";
            });
        };

        // সার্চ ফাংশনালিটি
        window.globalSearch = function() {
            const q = document.getElementById('main-search').value.toLowerCase();
            const res = document.getElementById('search-results');
            if(!q) { res.innerHTML = ""; return; }
            get(child(ref(db), 'invoices/')).then((snapshot) => {
                if (snapshot.exists()) {
                    let html = "";
                    for(let id in snapshot.val()) {
                        const item = snapshot.val()[id];
                        if(item.name.toLowerCase().includes(q) || item.invNo.toLowerCase().includes(q)) {
                            html += `<div class="search-item" onclick="loadInv('${id}')">${item.invNo} - ${item.name}</div>`;
                        }
                    }
                    res.innerHTML = html;
                }
            });
        };

        window.loadInv = function(id) {
            get(child(ref(db), 'invoices/' + id)).then((snapshot) => {
                const d = snapshot.val();
                document.getElementById('inv-no').value = d.invNo;
                document.getElementById('c-name').value = d.name;
                document.getElementById('advance').value = d.adv;
                document.getElementById('inv-date').value = d.date;
                const tb = document.getElementById('tbody');
                tb.innerHTML = "";
                d.items.forEach(i => addRow(i.d, i.t));
                document.getElementById('search-results').innerHTML = "";
                calculate();
            });
        };
    </script>

    <script>
        // ক্যালকুলেশন এবং ডাউনলোড লজিক
        document.getElementById('inv-date').value = new Date().toLocaleDateString('en-GB');

        function addRow(d='', t='') {
            const tbody = document.getElementById('tbody');
            const row = tbody.insertRow();
            row.innerHTML = `<td>${tbody.rows.length}</td><td><textarea class="item-desc">${d}</textarea></td><td><input type="number" class="qty" oninput="updateRow(this)"></td><td><input type="number" class="price" oninput="updateRow(this)"></td><td><input type="number" class="row-total" value="${t}" oninput="calculate()"></td>`;
        }

        function updateRow(el) {
            const row = el.closest('tr');
            const q = row.querySelector('.qty').value || 0;
            const p = row.querySelector('.price').value || 0;
            row.querySelector('.row-total').value = q * p;
            calculate();
        }

        function calculate() {
            let total = 0;
            document.querySelectorAll('.row-total').forEach(i => total += parseFloat(i.value) || 0);
            document.getElementById('sub-total').value = total;
            document.getElementById('due').value = total - (document.getElementById('advance').value || 0);
        }

        function downloadAction(type) {
            const choice = prompt("কি সেভ করবেন?\n1. শুধু ইনভয়েস\n2. শুধু সামারি\n3. সব (আলাদা পেজ)");
            const area = document.getElementById('printable-area');
            const invPart = document.getElementById('invoice-part');
            const sumPart = document.getElementById('summary-part');

            if(choice == '1') { sumPart.style.display = 'none'; invPart.style.display = 'block'; }
            else if(choice == '2') { invPart.style.display = 'none'; sumPart.style.display = 'block'; }
            else { invPart.style.display = 'block'; sumPart.style.display = 'block'; }

            if(type === 'pdf') {
                html2pdf().set({ margin:0.2, filename:'Bill.pdf', jsPDF:{format:'a4'} }).from(area).save();
            } else {
                html2canvas(area).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'Bill.jpg';
                    link.href = canvas.toDataURL("image/jpeg");
                    link.click();
                });
            }
        }

        // সেটিংস উইন্ডো কন্ট্রোল
        function openSettings() { document.getElementById('settings-modal').style.display='block'; }
        function closeSettings() { document.getElementById('settings-modal').style.display='none'; }

        function previewImg(input, id) {
            const reader = new FileReader();
            reader.onload = (e) => document.getElementById(id).src = e.target.result;
            reader.readAsDataURL(input.files[0]);
        }

        // সিল ড্র্যাগিং
        const seal = document.getElementById("seal-container");
        let isDragging = false;
        seal.onmousedown = () => isDragging = true;
        document.onmousemove = (e) => { if(isDragging) { seal.style.left = (e.pageX-60)+"px"; seal.style.top = (e.pageY-60)+"px"; } };
        document.onmouseup = () => isDragging = false;

        window.onload = () => addRow();
    </script>
</body>
</html>
