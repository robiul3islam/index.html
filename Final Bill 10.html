<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Inovera Creation - Billing System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #f28c28; --bg: #fffbf5; }
        body { font-family: 'Segoe UI', Arial; background: #e0e0e0; padding: 20px; }
        .controls { max-width: 850px; margin: 0 auto 20px; background: white; padding: 15px; border-radius: 8px; display: flex; gap: 10px; justify-content: center; }
        .invoice-container { max-width: 800px; margin: auto; background: white; padding: 40px; min-height: 1000px; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.2); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #logo-preview { max-width: 150px; border: 1px dashed #ccc; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        th, td { border: 1px solid var(--primary); padding: 8px; font-size: 14px; }
        input, textarea { width: 100%; border: none; outline: none; background: transparent; }
        button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: bold; }
        @media print { .no-print { display: none !important; } .invoice-container { box-shadow: none; width: 100%; } }
    </style>
</head>
<body>

    <div class="controls no-print">
        <button onclick="document.getElementById('logo-input').click()" style="background:#555;">Upload Logo</button>
        <button onclick="addRow()" style="background:#27ae60;">+ Add Item</button>
        <button onclick="saveInvoice()" id="save-btn" style="background:#3498db;">Save Online</button>
        <button onclick="exportPDF()" style="background:#9b59b6;">Download PDF</button>
        <input type="file" id="logo-input" accept="image/*" style="display:none" onchange="previewImg(this)">
    </div>

    <div class="invoice-container" id="printable-area">
        <div class="header">
            <h1 style="font-size: 40px; margin:0; color: var(--primary);">INVOICE</h1>
            <img id="logo-preview" src="https://via.placeholder.com/150x50?text=Logo+Upload">
        </div>

        <div style="display: flex; justify-content: space-between; background: var(--bg); padding: 10px; margin-bottom: 20px;">
            <div><strong>Inv No:</strong> <input type="text" id="inv-no" value="IC-2026-001"></div>
            <div><strong>Date:</strong> <input type="text" id="inv-date"></div>
        </div>

        <table>
            <tr><td width="20%"><strong>Client Name:</strong></td><td><input type="text" id="c-name" placeholder="Name"></td></tr>
        </table>

        <table id="item-table">
            <thead>
                <tr><th width="5%">SL</th><th>Description</th><th width="10%">Qty</th><th width="15%">Price</th><th width="15%">Total</th></tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>

        <div style="margin-left: auto; width: 40%;">
            <table>
                <tr><td align="right">Total:</td><td><input type="number" id="sub-total" readonly></td></tr>
                <tr><td align="right">Advance:</td><td><input type="number" id="advance" value="0" oninput="calculate()"></td></tr>
                <tr style="background:var(--bg);"><strong><td align="right">Due:</td><td><input type="number" id="due" readonly style="font-weight:bold;"></td></strong></tr>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD564XNDplN4_1YACVsGSPejchc3XMIB20",
            authDomain: "special-inventon.firebaseapp.com",
            databaseURL: "https://special-inventon-default-rtdb.firebaseio.com",
            projectId: "special-inventon",
            storageBucket: "special-inventon.firebasestorage.app",
            messagingSenderId: "188677302653",
            appId: "1:188677302653:web:d65812ec5a63f2c2cd4414"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.saveInvoice = function() {
            const items = [];
            document.querySelectorAll('#tbody tr').forEach(r => {
                items.push({
                    d: r.querySelector('.item-desc').value,
                    q: r.querySelector('.qty').value,
                    p: r.querySelector('.price').value,
                    t: r.querySelector('.row-total').value
                });
            });

            const data = {
                invNo: document.getElementById('inv-no').value,
                name: document.getElementById('c-name').value,
                total: document.getElementById('sub-total').value,
                adv: document.getElementById('advance').value,
                date: document.getElementById('inv-date').value,
                items: items,
                logo: document.getElementById('logo-preview').src
            };

            set(ref(db, 'invoices/' + data.invNo.replace(/\W/g, '_')), data)
                .then(() => alert("Saved Online!"))
                .catch((e) => alert("Error: " + e.message));
        };
    </script>

    <script>
        document.getElementById('inv-date').value = new Date().toLocaleDateString('en-GB');

        function previewImg(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => document.getElementById('logo-preview').src = e.target.result;
                reader.readAsDataURL(input.files[0]);
            }
        }

        function addRow() {
            const tbody = document.getElementById('tbody');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td align="center">${tbody.rows.length}</td>
                <td><textarea class="item-desc"></textarea></td>
                <td><input type="number" class="qty" oninput="updateRow(this)"></td>
                <td><input type="number" class="price" oninput="updateRow(this)"></td>
                <td><input type="number" class="row-total" oninput="calculate()"></td>
            `;
        }

        function updateRow(el) {
            const row = el.closest('tr');
            const q = parseFloat(row.querySelector('.qty').value) || 0;
            const p = parseFloat(row.querySelector('.price').value) || 0;
            if (q > 0 || p > 0) row.querySelector('.row-total').value = (q * p).toFixed(2);
            calculate();
        }

        function calculate() {
            let total = 0;
            document.querySelectorAll('.row-total').forEach(i => total += parseFloat(i.value) || 0);
            const adv = parseFloat(document.getElementById('advance').value) || 0;
            document.getElementById('sub-total').value = total.toFixed(2);
            document.getElementById('due').value = (total - adv).toFixed(2);
        }

        function exportPDF() {
            const element = document.getElementById('printable-area');
            html2pdf().from(element).save('Invoice_' + document.getElementById('inv-no').value + '.pdf');
        }

        window.onload = () => addRow();
    </script>
</body>
</html>
