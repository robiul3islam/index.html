<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Inovera Creation - Ultimate Billing System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #f28c28; --bg: #fffbf5; --red: #d32f2f; --green: #27ae60; --blue: #3498db; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #e0e0e0; padding: 20px; margin: 0; }
        
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #222; color: white; display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: #333; padding: 30px; border-radius: 10px; text-align: center; }

        .top-search-bar { max-width: 850px; margin: 0 auto 15px; background: #333; color: white; padding: 15px; border-radius: 8px; text-align: center; position: relative; }
        #main-search { width: 80%; padding: 12px; border-radius: 25px; border: none; outline: none; }
        #search-results { position: absolute; width: 80%; background: white; z-index: 1000; left: 50%; transform: translateX(-50%); border-radius: 0 0 10px 10px; max-height: 250px; overflow-y: auto; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .search-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; color: black; text-align: left; display: flex; justify-content: space-between; }

        .controls { max-width: 850px; margin: 0 auto 20px; background: white; padding: 15px; border-radius: 8px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        
        .invoice-container { 
            width: 210mm; 
            min-height: 297mm; 
            margin: auto; 
            background: white; 
            padding: 15mm; 
            position: relative; 
            box-sizing: border-box; 
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #logo-preview { max-width: 150px; cursor: pointer; min-height: 50px; border: 1px dashed #ccc; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        th, td { border: 1px solid var(--primary); padding: 6px; font-size: 14px; }
        th { background: var(--bg); }
        input, textarea, select { width: 100%; border: none; outline: none; background: transparent; font-family: inherit; }
        
        .seal-wrapper { display: flex; justify-content: flex-end; margin-top: 20px; margin-bottom: 20px; }
        #seal-container { width: 120px; text-align: center; }
        #seal-img { width: 100%; opacity: 0.8; cursor: pointer; }

        button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: bold; }
        .footer-info { margin-top: auto; padding-top: 20px; border-top: 2px solid var(--primary); display: flex; flex-direction: column; gap: 8px; font-size: 13px; }
        .footer-row { display: flex; align-items: center; gap: 10px; }
        .footer-icon { width: 22px; height: 22px; object-fit: contain; }

        /* "In Words" Bold Style */
        .words-container { font-weight: bold; }

        #summary-table th { background: #333; color: white; border: 1px solid #444; }
        #summary-table td { text-align: center; }

        @media print { .no-print { display: none !important; } .invoice-container { box-shadow: none; margin: 0; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--primary)">System Access</h2>
            <input type="password" id="sys-pass" placeholder="পাসওয়ার্ড দিন" style="padding:10px; margin-bottom:10px; text-align:center;"> <br>
            <button onclick="checkLogin()" style="background: var(--primary); width:100%;">Login</button>
        </div>
    </div>

    <div id="main-content" style="display:none;">
        <div class="top-search-bar no-print">
            <input type="text" id="main-search" placeholder="নাম অথবা বিল নম্বর লিখে খুঁজুন..." onkeyup="globalSearch()">
            <div id="search-results"></div>
        </div>

        <div class="controls no-print">
            <button onclick="newBill()" style="background:var(--blue);">+ New Bill</button>
            <button onclick="document.getElementById('logo-input').click()" style="background:#555;">Upload Logo</button>
            <button onclick="document.getElementById('seal-input').click()" style="background:#777;">Upload Seal</button>
            <button onclick="addRow()" style="background:var(--green);">+ Item</button>
            <button onclick="saveInvoice()" id="save-btn" style="background:#3498db;">Save Record</button>
            <button onclick="downloadAction('pdf')" style="background:#9b59b6;">Download PDF</button>
            <button onclick="downloadAction('jpg')" style="background:#e67e22;">Save JPG</button>
            <button onclick="deleteInvoice()" style="background:var(--red);">Delete Bill</button>
            <button onclick="location.reload()" style="background:#7f8c8d;">Logout</button>
            
            <input type="file" id="logo-input" accept="image/*" style="display:none" onchange="previewImage(this, 'logo-preview')">
            <input type="file" id="seal-input" accept="image/*" style="display:none" onchange="previewImage(this, 'seal-img')">
        </div>

        <div id="capture-area">
            <div class="invoice-container" id="invoice-page-part">
                <div class="header">
                    <h1 style="font-size: 40px; margin:0; color: #333;">INVOICE</h1>
                    <img id="logo-preview" src="https://via.placeholder.com/150x50?text=Logo">
                </div>
                
                <div style="display: flex; justify-content: space-between; background: var(--bg); padding: 10px; margin-bottom: 15px; border-top: 3px solid var(--primary);">
                    <div><strong>Inv No:</strong> <input type="text" id="inv-no" placeholder="Loading..." style="width:120px; font-weight:bold;"></div>
                    <div><strong>Date:</strong> <input type="text" id="inv-date"></div>
                </div>

                <table>
                    <tr>
                        <td width="12%"><strong>Company:</strong></td>
                        <td width="58%"><input type="text" id="c-company" placeholder="Client's Company"></td>
                        <td width="10%" align="center"><strong>Prep. by:</strong></td>
                        <td width="20%"><input type="text" id="prep-by" value="Inovera Creation" style="text-align:center; font-weight:bold; font-size:12px;"></td>
                    </tr>
                    <tr>
                        <td><strong>Name:</strong></td>
                        <td><input type="text" id="c-name" placeholder="Client Name" oninput="showSummary(this.value)" style="font-weight:bold;"></td>
                        <td align="center"><strong>Prep. for:</strong></td>
                        <td><input type="text" id="prep-for" placeholder="Target Person/Dept" style="text-align:center; font-size:12px;"></td>
                    </tr>
                    <tr>
                        <td><strong>Address:</strong></td>
                        <td><input type="text" id="c-address" placeholder="Client Address"></td>
                        <td colspan="2" rowspan="2" style="background:#f9f9f9; text-align:center; vertical-align:middle; color:#888; font-size:10px;">AUTHORIZED SIGNATURE</td>
                    </tr>
                    <tr>
                        <td><strong>Contact:</strong></td>
                        <td><input type="text" id="c-contact" placeholder="Phone Number"></td>
                    </tr>
                </table>

                <table id="item-table">
                    <thead>
                        <tr><th width="5%">SL</th><th width="55%">Description</th><th width="10%">Qty</th><th width="15%">Price</th><th width="15%">Total</th></tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>

                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="width: 50%;">
                        <p class="words-container" style="margin-bottom: 5px;">In Words: <span id="words-area"></span></p>
                        <p style="color: red; font-weight: bold; font-size: 14px; margin-top: 0;">* Price Excluding VAT and TAX</p>
                    </div>
                    <div style="width: 45%;">
                        <table>
                            <tr><td style="border:none; text-align:right;">Sub Total:</td><td><input type="number" id="sub-total" readonly></td></tr>
                            <tr><td style="border:none; text-align:right;">Advance:</td><td><input type="number" id="advance" value="0" oninput="calculate()"></td></tr>
                            <tr style="background:var(--bg);"><td style="border:none; text-align:right;"><strong>Due:</strong></td><td><input type="number" id="due" readonly style="font-weight:bold;"></td></tr>
                        </table>
                    </div>
                </div>

                <div class="seal-wrapper">
                    <div id="seal-container">
                        <img id="seal-img" src="https://via.placeholder.com/120x120?text=Digital+Seal">
                        <p style="font-size: 10px; margin-top: 5px; color: #555;">Authorized Seal</p>
                    </div>
                </div>

                <div class="footer-info">
                    <div class="footer-row"><img src="https://cdn-icons-png.flaticon.com/512/724/724664.png" class="footer-icon"><span>+880 1642 60 98 60</span></div>
                    <div class="footer-row"><img src="https://cdn-icons-png.flaticon.com/512/281/281769.png" class="footer-icon"><span>inoveracreation@gmail.com</span></div>
                    <div class="footer-row"><img src="https://cdn-icons-png.flaticon.com/512/484/484167.png" class="footer-icon"><span>Level-7, Resourceful Paltan City Tower, 51/51-A Purana Paltan, Dhaka-1000</span></div>
                </div>
            </div>

            <div class="invoice-container" id="summary-page" style="display:none; margin-top:20px;">
                <h2 style="text-align:center; color:var(--primary); text-transform: uppercase; border-bottom: 2px solid var(--primary); padding-bottom: 10px;">Statement of Outstanding Balance</h2>
                <div style="margin-bottom: 15px;">
                    <p>Client Name: <strong id="sum-client-name" style="font-size: 18px;">---</strong></p>
                </div>
                <table id="summary-table">
                    <thead>
                        <tr>
                            <th class="no-print" width="5%">Select</th>
                            <th width="20%">Inv No</th>
                            <th width="20%">Date</th>
                            <th width="20%">Total</th>
                            <th width="15%">Paid</th>
                            <th width="20%">Due</th>
                        </tr>
                    </thead>
                    <tbody id="sum-tbody"></tbody>
                </table>
                <div style="text-align: right; font-weight: bold; font-size: 18px; padding: 15px; background: var(--bg); border: 2px solid var(--primary); margin-top: 10px;">
                    Total Selected Due: <span id="total-selected-due">0.00</span> BDT
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 15px;">* This is a computer generated statement and does not require a physical signature.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, set, get, child, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD564XNDplN4_1YACVsGSPejchc3XMIB20",
            authDomain: "special-inventon.firebaseapp.com",
            databaseURL: "https://special-inventon-default-rtdb.firebaseio.com",
            projectId: "special-inventon"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.checkLogin = async function() {
            const input = document.getElementById('sys-pass').value;
            const snap = await get(child(ref(db), 'settings/passwords'));
            const valid = snap.exists() ? snap.val().login : "1234";
            if(input === valid) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                setTodayDate();
                autoGenerateInvNo();
            } else { alert("Wrong Password!"); }
        };

        async function autoGenerateInvNo() {
            const snap = await get(child(ref(db), 'invoices/'));
            if (snap.exists()) {
                const invoices = Object.keys(snap.val());
                const lastId = invoices[invoices.length - 1];
                const lastNum = parseInt(lastId.split('_').pop()) || 0;
                const nextNum = (lastNum + 1).toString().padStart(3, '0');
                document.getElementById('inv-no').value = `IC-2026-${nextNum}`;
            } else {
                document.getElementById('inv-no').value = "IC-2026-001";
            }
        }

        window.saveInvoice = function() {
            const originalId = document.getElementById('inv-no').value;
            const dbId = originalId.replace(/\W/g, '_');
            const items = [];
            document.querySelectorAll('#tbody tr').forEach(r => {
                items.push({ 
                    d: r.querySelector('.item-desc').value, 
                    q: r.querySelector('.qty').value, 
                    p: r.querySelector('.price').value, 
                    t: r.querySelector('.row-total').value 
                });
            });

            const data = {
                invNo: originalId, 
                name: document.getElementById('c-name').value,
                company: document.getElementById('c-company').value,
                address: document.getElementById('c-address').value,
                contact: document.getElementById('c-contact').value,
                prepBy: document.getElementById('prep-by').value,
                prepFor: document.getElementById('prep-for').value,
                total: document.getElementById('sub-total').value, 
                adv: document.getElementById('advance').value,
                date: document.getElementById('inv-date').value, 
                items: items, 
                logo: document.getElementById('logo-preview').src, 
                seal: document.getElementById('seal-img').src
            };
            set(ref(db, 'invoices/' + dbId), data).then(() => {
                alert("Saved Successfully!");
                showSummary(data.name); 
            });
        };

        window.deleteInvoice = async function() {
            const pass = prompt("ডিলিট করার জন্য পাসওয়ার্ড দিন:");
            const snap = await get(child(ref(db), 'settings/passwords'));
            const valid = snap.exists() ? snap.val().login : "1234";
            
            if(pass === valid) {
                const id = document.getElementById('inv-no').value.replace(/\W/g, '_');
                if(confirm("Are you sure you want to delete this bill?")) {
                    remove(ref(db, 'invoices/' + id)).then(() => { 
                        alert("Deleted!"); 
                        location.reload(); 
                    });
                }
            } else { alert("ভুল পাসওয়ার্ড!"); }
        };

        window.globalSearch = function() {
            const q = document.getElementById('main-search').value.toLowerCase();
            const res = document.getElementById('search-results');
            if(!q) { res.innerHTML = ""; return; }
            get(child(ref(db), 'invoices/')).then((snap) => {
                if(snap.exists()) {
                    let html = "";
                    for(let id in snap.val()) {
                        const m = snap.val()[id];
                        if(m.name.toLowerCase().includes(q) || m.invNo.toLowerCase().includes(q)) {
                            html += `<div class="search-item" onclick="loadInv('${id}')"><span>${m.invNo} - ${m.name}</span></div>`;
                        }
                    }
                    res.innerHTML = html;
                }
            });
        };

        window.loadInv = function(id) {
            get(child(ref(db), 'invoices/' + id)).then((snap) => {
                const d = snap.val();
                document.getElementById('inv-no').value = d.invNo;
                document.getElementById('inv-date').value = d.date;
                document.getElementById('c-name').value = d.name;
                document.getElementById('c-company').value = d.company || '';
                document.getElementById('c-address').value = d.address || '';
                document.getElementById('c-contact').value = d.contact || '';
                document.getElementById('prep-by').value = d.prepBy || 'Inovera Creation';
                document.getElementById('prep-for').value = d.prepFor || '';
                document.getElementById('advance').value = d.adv;
                const tb = document.getElementById('tbody'); tb.innerHTML = "";
                d.items.forEach(i => addRow(i.d, i.q, i.p, i.t));
                document.getElementById('logo-preview').src = d.logo;
                document.getElementById('seal-img').src = d.seal || 'https://via.placeholder.com/120x120?text=Digital+Seal';
                document.getElementById('search-results').innerHTML = "";
                calculate();
                showSummary(d.name); 
            });
        };

        window.showSummary = function(clientName) {
            const sumPage = document.getElementById('summary-page');
            const sumTbody = document.getElementById('sum-tbody');
            const sumClientName = document.getElementById('sum-client-name');
            
            if(!clientName || clientName.length < 2) {
                sumPage.style.display = 'none';
                return;
            }

            get(child(ref(db), 'invoices/')).then((snap) => {
                if(snap.exists()) {
                    let html = "";
                    let hasData = false;
                    const allData = snap.val();
                    
                    for(let id in allData) {
                        const inv = allData[id];
                        if(inv.name.toLowerCase() === clientName.toLowerCase()) {
                            const total = parseFloat(inv.total) || 0;
                            const adv = parseFloat(inv.adv) || 0;
                            const due = total - adv;
                            
                            html += `<tr>
                                <td class="no-print"><input type="checkbox" class="sum-check" data-due="${due}" onchange="calcSumDue()"></td>
                                <td>${inv.invNo}</td>
                                <td>${inv.date}</td>
                                <td>${total.toFixed(2)}</td>
                                <td>${adv.toFixed(2)}</td>
                                <td style="color: ${due > 0 ? 'red' : 'green'}; font-weight: bold;">${due.toFixed(2)}</td>
                            </tr>`;
                            hasData = true;
                        }
                    }

                    if(hasData) {
                        sumTbody.innerHTML = html;
                        sumClientName.innerText = clientName;
                        sumPage.style.display = 'block';
                        calcSumDue();
                    } else {
                        sumPage.style.display = 'none';
                    }
                }
            });
        };

        window.calcSumDue = function() {
            let total = 0;
            document.querySelectorAll('.sum-check:checked').forEach(cb => {
                total += parseFloat(cb.getAttribute('data-due')) || 0;
            });
            document.getElementById('total-selected-due').innerText = total.toFixed(2);
        };
    </script>

    <script>
        function previewImage(input, targetId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => document.getElementById(targetId).src = e.target.result;
                reader.readAsDataURL(input.files[0]);
            }
        }

        function setTodayDate() {
            const today = new Date();
            const dateStr = today.getDate().toString().padStart(2, '0') + '/' + 
                          (today.getMonth() + 1).toString().padStart(2, '0') + '/' + today.getFullYear();
            document.getElementById('inv-date').value = dateStr;
        }

        function addRow(d='', q='', p='', t='') {
            const tbody = document.getElementById('tbody');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td align="center">${tbody.rows.length}</td>
                <td><textarea class="item-desc" rows="1">${d}</textarea></td>
                <td><input type="number" class="qty" value="${q}" oninput="updateRow(this)"></td>
                <td><input type="number" class="price" value="${p}" oninput="updateRow(this)"></td>
                <td><input type="number" class="row-total" value="${t}" readonly></td>`;
            calculate();
        }

        function updateRow(el) {
            const row = el.closest('tr');
            const q = row.querySelector('.qty').value || 0;
            const p = row.querySelector('.price').value || 0;
            row.querySelector('.row-total').value = (q * p).toFixed(2);
            calculate();
        }

        function calculate() {
            let total = 0;
            document.querySelectorAll('.row-total').forEach(i => total += parseFloat(i.value) || 0);
            const adv = parseFloat(document.getElementById('advance').value) || 0;
            document.getElementById('sub-total').value = total.toFixed(2);
            document.getElementById('due').value = (total - adv).toFixed(2);
            document.getElementById('words-area').innerText = numberToWords(Math.floor(total)) + " Taka Only";
        }

        function newBill() {
            if(confirm("নতুন বিল শুরু করবেন?")) { location.reload(); }
        }

        function numberToWords(num) {
            const a = ['','one ','two ','three ','four ','five ','six ','seven ','eight ','nine ','ten ','eleven ','twelve ','thirteen ','fourteen ','fifteen ','sixteen ','seventeen ','eighteen ','nineteen '];
            const b = ['', '', 'twenty','thirty','forty','fifty','sixty','seventy','eighty','ninety'];
            let n = ('000000000' + Math.floor(num)).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
            if (!n) return ''; 
            let str = '';
            str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'crore ' : '';
            str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'lakh ' : '';
            str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'thousand ' : '';
            str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'hundred ' : '';
            str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
            return str.toUpperCase();
        }

        async function downloadAction(type) {
            const choice = prompt("কি ডাউনলোড করতে চান?\n1. Invoice Only\n2. Summary Only");
            const inv = document.getElementById('invoice-page-part');
            const sum = document.getElementById('summary-page');
            const billNo = document.getElementById('inv-no').value;
            
            let target = (choice == '1') ? inv : (choice == '2' ? sum : null);
            if(!target) return;

            const opt = { 
                margin: 0, 
                filename: choice == '1' ? `Invoice_${billNo}.pdf` : `Summary_${document.getElementById('c-name').value}.pdf`, 
                image: { type: 'jpeg', quality: 1 }, 
                html2canvas: { scale: 3, useCORS: true }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
            };
            
            if(type === 'pdf') await html2pdf().set(opt).from(target).save();
            else {
                const canvas = await html2canvas(target, { scale: 3 });
                const link = document.createElement('a');
                link.download = choice == '1' ? `Invoice_${billNo}.jpg` : `Summary.jpg`;
                link.href = canvas.toDataURL("image/jpeg", 1.0);
                link.click();
            }
        }

        window.onload = () => { addRow(); };
    </script>
</body>
</html>
