<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Inovera Creation - Ultimate Billing System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* আপনার অরিজিনাল সিএসএস ডিজাইন (হুবহু রাখা হয়েছে) */
        :root { --primary: #f28c28; --bg: #fffbf5; --red: #d32f2f; --green: #27ae60; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #e0e0e0; padding: 20px; }
        
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #222; color: white; display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: #333; padding: 30px; border-radius: 10px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .login-box input { padding: 10px; margin: 10px; border-radius: 5px; border: none; width: 200px; text-align: center; }

        .top-search-bar { max-width: 850px; margin: 0 auto 15px; background: #333; color: white; padding: 15px; border-radius: 8px; text-align: center; }
        #main-search { width: 60%; padding: 10px; border-radius: 5px; border: none; }
        .controls { max-width: 850px; margin: 0 auto 20px; background: white; padding: 15px; border-radius: 8px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .invoice-container { max-width: 800px; margin: auto; background: white; padding: 40px; min-height: 1050px; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.2); box-sizing: border-box; }
        .page-break { page-break-before: always; margin-top: 50px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #logo-preview { max-width: 150px; cursor: pointer; border: 1px dashed #ccc; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        th, td { border: 1px solid var(--primary); padding: 8px; font-size: 14px; }
        th { background: var(--bg); }
        input, textarea, select { width: 100%; border: none; outline: none; background: transparent; font-family: inherit; }
        #c-name { font-weight: bold; font-size: 1.1em; }
        #seal-container { position: absolute; width: 120px; cursor: move; z-index: 100; top: 800px; left: 600px; user-select: none; }
        #seal-img { width: 100%; opacity: 0.8; }
        .summary-title { font-size: 20px; font-weight: bold; color: var(--primary); margin-bottom: 15px; text-align: center; }
        #search-results { position: absolute; width: 600px; background: white; z-index: 1000; box-shadow: 0 10px 20px rgba(0,0,0,0.3); left: 50%; transform: translateX(-50%); }
        .search-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; color: black; text-align: left; }
        button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: bold; }
        
        .modal { display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); }
        .modal-content { background:#fff; margin:15% auto; padding:20px; width:300px; border-radius:10px; text-align:center; }

        @media print { 
            .no-print, .top-search-bar, .controls, #login-screen { display: none !important; }
            .invoice-container { box-shadow: none; width: 100%; padding: 20px; }
        }
    </style>
</head>
<body>

    <script>
        // --- আপনার সব ফিচার ঠিক রেখে শুধুমাত্র ডাউনলোড ফাংশনটি নিচে আপডেট করা হলো ---

        async function downloadAction(type) {
            const choice = prompt("কিভাবে সেভ করতে চান?\n1. শুধুমাত্র ইনভয়েস (Page 1)\n2. শুধুমাত্র সামারি (Page 2)\n3. সব একত্রে (Page 1 & 2)");
            
            if (!choice) return;

            const area = document.getElementById('printable-area');
            const invPart = document.getElementById('invoice-page-part');
            const sumPart = document.getElementById('summary-page');

            // অরিজিনাল লুক সেভ করা
            const originalInv = invPart.style.display;
            const originalSum = sumPart.style.display;

            // পেজ ফিল্টার লজিক
            if (choice === '1') { sumPart.style.display = 'none'; invPart.style.display = 'block'; }
            else if (choice === '2') { invPart.style.display = 'none'; sumPart.style.display = 'block'; sumPart.classList.remove('page-break'); }
            else { invPart.style.display = 'block'; sumPart.style.display = 'block'; sumPart.classList.add('page-break'); }

            if (type === 'pdf') {
                const opt = {
                    margin: 0,
                    filename: 'Invoice.pdf',
                    image: { type: 'jpeg', quality: 1 },
                    html2canvas: { scale: 3, useCORS: true }, // হাই রেজোলিউশন
                    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                };
                await html2pdf().set(opt).from(area).save();
            } else {
                // JPG সমস্যা সমাধান: scale: 3 দিয়ে ছবি পরিষ্কার করা হয়েছে
                html2canvas(area, {
                    scale: 3, 
                    useCORS: true,
                    backgroundColor: "#ffffff"
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'Invoice.jpg';
                    link.href = canvas.toDataURL("image/jpeg", 1.0);
                    link.click();
                });
            }

            // ডাউনলোড শেষে আগের অবস্থায় ফেরত আনা
            setTimeout(() => {
                invPart.style.display = originalInv;
                sumPart.style.display = originalSum;
                sumPart.classList.add('page-break');
            }, 1000);
        }

        // বাকি আপনার সব অরিজিনাল জাভাস্ক্রিপ্ট ফাংশন (addRow, calculate, seal drag) নিচের মতো থাকবে
    </script>
</body>
</html>
